{
  email {$ACME_EMAIL}
}

cp.{$DOMAIN_BASE} {
  reverse_proxy control-plane:8000
}

{$DOMAIN_BASE} {
  # Browser WebSocket API cannot set custom headers, so Obsidian plugin
  # sends CWT token as ?token= query param. Extract it and set as
  # Authorization header for relay-server, then strip ?token= from URL
  # (relay-server also tries to parse ?token= in its own binary format,
  # which fails on CWT tokens â€” so we must remove it).
  @token_in_query query token=*
  handle @token_in_query {
    route {
      request_header Authorization "Bearer {query.token}"
      uri query -token
      reverse_proxy relay-server:8080
    }
  }

  handle {
    reverse_proxy relay-server:8080
  }
}

# Web publishing (optional)
# Set WEB_PUBLISH_DOMAIN in .env to enable (e.g., docs.example.com)
# Default 'web-publish.disabled' is a placeholder that won't match real requests
{$WEB_PUBLISH_DOMAIN:web-publish.disabled} {
  reverse_proxy web-publish:3000
}

